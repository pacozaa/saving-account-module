sequenceDiagram
    participant Customer as CUSTOMER (Client)
    participant Gateway as API Gateway
    participant Auth as Auth Service
    participant UsersDB as Users DB
    participant Transfer as Transfer Service
    participant Account as Account Service
    participant AccountsDB as Accounts DB
    participant Transaction as Transaction Service
    participant TransDB as Transactions DB

    Note over Customer,TransDB: Feature 5: Money Transfer

    Note over Customer: Step 1: CUSTOMER logs in
    
    Customer->>Gateway: POST /auth/login<br/>{email, password}
    Gateway->>Auth: Validate credentials
    Auth->>UsersDB: Verify user & get userId
    Auth-->>Gateway: {token, userId}
    Gateway-->>Customer: {token, userId}
    
    Note over Customer: Step 2: Initiate transfer with PIN
    
    Customer->>Gateway: POST /transfer<br/>Authorization: Bearer {token}<br/>{fromAccountNumber,<br/>toAccountNumber,<br/>amount, pin}
    Gateway->>Gateway: Validate JWT token
    Gateway->>Gateway: Extract userId from token
    Gateway->>Transfer: Forward transfer request
    
    Note over Transfer,Auth: Validate PIN
    
    Transfer->>Auth: POST /auth/verify-pin<br/>{userId, pin}
    Auth->>UsersDB: SELECT User WHERE id = userId
    UsersDB-->>Auth: User with hashedPin
    Auth->>Auth: Verify PIN (BCrypt)
    
    alt Invalid PIN
        Auth-->>Transfer: 401 Invalid PIN
        Transfer-->>Gateway: 401 Invalid PIN
        Gateway-->>Customer: Transfer failed: Invalid PIN
    else Valid PIN
        Auth-->>Transfer: 200 PIN verified
        
        Note over Transfer,Account: Step 3: Validate sender account
        
        Transfer->>Account: GET /accounts/number/{fromAccountNumber}
        Account->>AccountsDB: SELECT Account
        
        alt Account not found or not owned by user
            AccountsDB-->>Account: Not found / Wrong owner
            Account-->>Transfer: 404 or 403 Forbidden
            Transfer-->>Gateway: Error: Invalid sender account
            Gateway-->>Customer: Transfer failed
        else Sender account valid
            AccountsDB-->>Account: Sender account details
            Account-->>Transfer: {accountId, balance, userId}
            
            Transfer->>Transfer: Verify account ownership<br/>(userId matches token)
            Transfer->>Transfer: Validate amount > 0
            Transfer->>Transfer: Check sufficient funds<br/>(balance >= amount)
            
            alt Insufficient funds
                Transfer-->>Gateway: 400 Insufficient funds
                Gateway-->>Customer: Transfer failed:<br/>Insufficient funds
            else Sufficient funds
                
                Note over Transfer,Account: Step 4: Validate receiver account
                
                Transfer->>Account: GET /accounts/number/{toAccountNumber}
                Account->>AccountsDB: SELECT Account
                
                alt Receiver account not found
                    AccountsDB-->>Account: Not found
                    Account-->>Transfer: 404 Account not found
                    Transfer-->>Gateway: Error: Invalid receiver account
                    Gateway-->>Customer: Transfer failed:<br/>Receiver account not found
                else Receiver account valid
                    AccountsDB-->>Account: Receiver account details
                    Account-->>Transfer: {receiverAccountId}
                    
                    Transfer->>Transfer: Validate not same account<br/>(sender != receiver)
                    
                    Note over Transfer,Account: Step 5: Deduct from sender
                    
                    Transfer->>Account: PUT /accounts/{senderAccountId}/balance<br/>{amount: -transferAmount}
                    Account->>AccountsDB: UPDATE Account<br/>SET balance = balance - amount<br/>WHERE id = senderAccountId
                    AccountsDB-->>Account: Updated
                    Account-->>Transfer: {newBalance}
                    
                    Note over Transfer,Account: Step 6: Add to receiver
                    
                    Transfer->>Account: PUT /accounts/{receiverAccountId}/balance<br/>{amount: +transferAmount}
                    Account->>AccountsDB: UPDATE Account<br/>SET balance = balance + amount<br/>WHERE id = receiverAccountId
                    AccountsDB-->>Account: Updated
                    Account-->>Transfer: {receiverNewBalance}
                    
                    Note over Transfer,Transaction: Step 7: Log transactions
                    
                    Transfer->>Transaction: POST /transactions<br/>{accountId: senderAccountId,<br/>type=TRANSFER_OUT,<br/>amount, toAccountNumber}
                    Transaction->>TransDB: INSERT Transaction
                    TransDB-->>Transaction: Logged
                    Transaction-->>Transfer: {transactionId}
                    
                    Transfer->>Transaction: POST /transactions<br/>{accountId: receiverAccountId,<br/>type=TRANSFER_IN,<br/>amount, fromAccountNumber}
                    Transaction->>TransDB: INSERT Transaction
                    TransDB-->>Transaction: Logged
                    Transaction-->>Transfer: {transactionId}
                    
                    Transfer-->>Gateway: 200 OK<br/>{transactionId,<br/>newBalance,<br/>message: "Transfer successful"}
                    Gateway-->>Customer: Transfer successful!<br/>New balance: {newBalance} THB
                end
            end
        end
    end
